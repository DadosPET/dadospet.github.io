<!DOCTYPE HTML>
<html>
	<head>
		<title>CinQuest - Design dos Sistemas</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="assets/css/main.css" />
		<!--[if lte IE 9]><link rel="stylesheet" href="assets/css/ie9.css" /><![endif]-->
		<!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
	</head>
	<body>

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
					<div id="main">
						<div class="inner">

							<!-- Header -->
								<header id="header">
									<a href="index.html" class="logo"><strong>CinQuest</strong>, design dos sistemas, diálogos</a>
									<ul class="icons">
										<li><a href="https://github.com/pet-informatica/CinQuest" class="icon fa-github"><span class="label">GitHub</span></a></li>
										<li><a href="https://pet-informatica.github.io/cinquest" class="icon fa-home"><span class="label">Home</span></a></li>
									</ul>
								</header>

							<!-- Banner -->
								<section>
										<header>
											<h1>Sistema de Diálogos <i class="icon fa-comment"></i></h1>
										</header>
										<p>
											Esse documento detalha a criação de novos diálogos, e como eles são inseridos e exibidos dentro do jogo. O sistema de diálogos envolve, dentre outros, os componentes abaixo:
										</p>
										<ul>
											<li><a href="#tree">DialogTree.cs</a></li>
											<li><a href="#nodes">DialogTreeNode.cs</a></li>
											<li><a href="#questnodes">Quest Nodes</a></li>
											<li><a href="#manager">DialogManager.cs</a></li>
											<li><a href="#speaker">Speaker.cs</a></li>
											<li><a href="#interativespeaker">Extensões do Speaker</a></li>
										</ul>

										<!-- dialog tree section -->
										<h2 id="tree">DialogTree.cs</h2>
										<p>
											Uma <a href="#">DialogTree</a> é uma estrutura que armazena um fluxo de diálogos que se pode ter com um NPC. Ela possue um <a href="#nodes">DialogTreeNode</a> como raiz, e cada DialogTreeNode possue nós filhos, que podem ser alcançados a partir de respostas específicas do jogador, ramificando a interação entre NPC e jogador e produzindo respostas diferentes para ações diferentes do usuáro.
										</p>
										<img src="images/dialogtree.png"/>
										<p/>

										<!-- nodes section -->
										<h2 id="nodes">DialogTreeNode.cs</h2>
										<p>
											Cada nó de uma <a href="#tree">DialogTree</a> representa as possíveis falas de um NPC no jogo.
										</p>
										<pre><code>
public class DialogTreeNode : ScriptableObject
{
    List<int> preconditionIds;
    List<int> lockconditionIds;
    List<int> rewardIds;
    string response;
    string message;
    List<DialogTreeNode> children;

    ...
}
										</code></pre>
										<p>
											O campo <code>message</code> será exibido na tela sendo a fala do NPC para este nó. Já o campo <code>response</code>, é que resposta do jogador, para um nó anterior, o leva à chegar neste nó. Portanto, em um dado nó, o <a href="manager">DialogManager</a> irá exibir como texto de fala do NPC a <code>message</code> deste nó, e vai dar como opções de resposta para esta <code>message</code> todas as <code>responses</code> que estão nos <code>children</code> nodes deste nó.
										</p>
										<p>
											Para que uma fala apareça para o jogador os campos <code>preConditionIds</code> e <code>lockConditionsIds</code> deverão ser respeitados
										</p>
										<ul>
											<li><code>preConditionIds</code>: lista de ids de PreConditions que serão necessários que o jogador tenha recebido anteriormente para que seja possível que o diálogo do nó seja disponibilizado.</li>
											<li><code>lockConditionIds</code>: lista de ids de PreConditions que, caso o jogador possua, não permitirá a aparição do diálogo do nó.</li>
										</ul>
										<p>É possível que ao passar por um nó da DialogTree o jogador receba <a href="quest.html#rewards">rewards</a>, as quais deverão ser colocadas no campo rewardIds.</p>

										<!-- questcs section -->
										<h2 id="questnodes">StartQuestTreeNode.cs e EndQuestTreeNode.cs</h2>
										<p>
											Existem dois nós especiais em uma <a href="#tree">DialogTree</a>: o nó que inicia uma <a href="quest.html">Quest</a> e o que termina uma Quest. Esse dois nós herdam todas as características do <a href="#nodes">DialogTreeNode</a> e adicionam o campo para o id da quest.
										</p>
										<p>No caso do StartQuestTreeNode, será verificada a possibilidade de ativar a quest.</p>
										<pre><code>
public class StartQuestTreeNode : DialogTreeNode
{
    int questId;
    public override void Execute()
    {
        ...

        Quest quest = user.GetQuest(QuestID);
        if (quest != null && !quest.Unlocked)
        {
            quest.Activate(user);
            GameManager.Instance.UpdateQuestUI();
        }
    }
}
									</code></pre>
									<p>Já no caso do nó que termina uma Quest, será verificado a possibilidade de finalizar a quest.</p>
									<pre><code>
public class EndQuestTreeNode : DialogTreeNode
{
    int questId;
    public override void Execute()
    {
        ...

        Quest quest = user.GetQuest(QuestID);
        if (quest != null && !quest.Done)
        {
            quest.Finish(user);
            AlertBox.Instance.OpenWindow (GameConstants.QUEST_COMPLETED, quest.QuestDoneMessage);
            MusicPlayer.Instance.PlayFX (doneFX);
            GameManager.Instance.UpdateQuestUI();
        }
    }
}
									</pre></code>
									<p>Ambas as ações são realizadas dentro do método <code>Execute()</code> do DialogTreeNode, que é executado assim que o jogador alcança este nó pela DialogTree</p>

									<!-- dialog manager section -->
									<h2 id="manager">DialogManger.cs</h2>
									<p>
										O gerenciador de diálogos é responsável por controlar toda a interação entre jogador e NPC. Ele possue um método <code>Speak()</code> capaz de invocar uma box de diálogo, dado uma <a href="#tree">DialogTree</a> e um <a href="#speaker">Speaker</a>. Toda a interação realizada pelo resto do díalogo, como passar de <a href="#nodes">DialogTreeNode</a> em DialogTreeNode, exibir as mensagens e esperar pela resposta do jogador será gerenciada por esta classe.
									</p>
									<pre><code>
...

public bool Speak(DialogTree dialog, Speaker speaker)
{
    if (IsSpeaking && dialog.Priority <= curDialog.Priority)
        return false;
    WaitUntilItEnds ();
    return StartConversation (dialog, speaker) != 0f;
}

...
									</code></pre>

								<!-- speaker section -->
								<h2 id="speaker">Speaker.cs</h2>
								<p>
									Esta classe permite à um NPC iniciar <a href="#">diálogos</a>. Ela recebe uma lista de <a href="#tree">DialogTrees</a>, que serão todas as árvores de diálogos que este NPC será capaz de falar, e se comunica com o <a href="manager">DialogManager</a> para iniciar um diálogo através do método <code>Speak()</code>. Entretando, apesar de tornar o NPC capaz de interagir com o jogador, ela não especifica como essa interação irá ocorrer, ou seja, que input iniciará o diálogo. Para isso, ela pode ser extendida pelas classes <a href="#interativespeaker">InterativeSpeaker.cs</a> ou <a href="autospeaker">AutoSpeaker.cs</a>.
								</p>
								<pre><code>
public class Speaker : MonoBehaviour
{
    public List<DialogTree> dialogs;
    public int defaultDialogIndex;
    protected DialogManager dialogManager;

    ...
}
								</code></pre>

								<h2 id="interativespeaker">InterativeSpeaker.cs</h2>
								<p>
									É uma extensão da classe <a href="#speaker">Speaker</a> para definir de que forma os diálogos do NPC serão iniciados. O InterativeSpeaker espera que o jogador se aproxime do NPC, e aperte o botão de interação do teclado para iniciar o diálogo.
								</p>
								<pre><code>
public class InterativeSpeaker : Speaker
{
    ...

    void OnTriggerStay2D(Collider2D collider)
    {
        if (collider.tag == "PlayerFront")
        {
            if (Input.GetButtonDown("Interaction"))
            {
                Speak();
            }
        }
    }
}
								</code></pre>

								<h2 id="autospeaker">AutoSpeaker.cs</h2>
								<p>
									É uma extensão da classe <a href="#speaker">Speaker</a> para definir de que forma os diálogos do NPC serão iniciados. O AutoSpeaker inicia o diálogo automaticamente assim que o jogador entra na cena em que o NPC está.
								</p>
								</section>
						</div>
					</div>

				<!-- SideBar -->
					<div id="sidebar">
						<div class="inner">


							<!-- System Design section -->
								<nav id="menu">

									<header class="major">
										<h2>Design dos Sistemas</h2>
									</header>
									<ul>
										<li>
											<span class="opener">Quest</span>
											<ul>
												<li><a href="quest.html#preconditions">PreConditions</a></li>
												<li><a href="quest.html#rewards">Rewards</a></li>
												<li><a href="quest.html#questcs">Quest.cs</a></li>
												<li><a href="quest.html#xmlcollections">Coleções XML</a></li>
												<li><a href="quest.html#managers">Gerenciadores</a></li>
												<li><a href="quest.html#ui">UI</a></li>
											</ul>
										</li>
										<li>
											<span class="opener">Diálogo</span>
											<ul>
												<li><a href="#tree">DialogTree.cs</a></li>
												<li><a href="#nodes">DialogTreeNode.cs</a></li>
												<li><a href="#questnodes">Quest Nodes</a></li>
												<li><a href="#manager">DialogManager.cs</a></li>
												<li><a href="#speaker">Speaker.cs</a></li>
												<li><a href="#interativespeaker">Extensões do Speaker</a></li>
											</ul>
										</li>
										<li>
											<span class="opener">Inventário</span>
											<ul>
												<li><a href="inventory.html#genericitem">Itens Genéricos</a></li>
												<li><a href="inventory.html#userinventory">Inventário</a></li>
												<li><a href="inventory.html#item">Item.cs</a></li>
												<li><a href="inventory.html#slot">Slot.cs</a></li>
												<li><a href="inventory.html#inventoryui">UI</a></li>
											</ul>
										</li>
										<li><a href="musicplayer.html#">Music Player</a></li>
										<li><a href="user.html#">User</a></li>
									</ul>

									<br/>
									<header class="major">
										<h2>Tutoriais</h2>
									</header>
									<ul>
										<li>
											<span class="opener">Quest</span>
											<ul>
												<li><a href="#">PreConditions</a></li>
												<li><a href="#">Rewards</a></li>
												<li><a href="#">Quest.cs</a></li>
												<li><a href="#">Coleções XML</a></li>
												<li><a href="#">Gerenciadores</a></li>
												<li><a href="#">UI</a></li>
											</ul>
										</li>
										<li>
											<span class="opener">Diálogo</span>
											<ul>
												<li><a href="#">Dialog Tree</a></li>
												<li><a href="#">Dialog Tree Node</a></li>
												<li><a href="#">Quest Nodes</a></li>
												<li><a href="#">Speaker</a></li>
												<li><a href="#">Interative Speaker</a></li>
												<li><a href="#">Auto Speaker</a></li>
											</ul>
										</li>
										<li>
											<span class="opener">Inventário</span>
											<ul>
												<li><a href="#">Lorem Dolor</a></li>
												<li><a href="#">Ipsum Adipiscing</a></li>
												<li><a href="#">Tempus Magna</a></li>
												<li><a href="#">Feugiat Veroeros</a></li>
											</ul>
										</li>
									</ul>
								</nav>
							<!-- Section -->
								<section>
									<header class="major">
										<h2>Contate-nos</h2>
									</header>
									<p>O CinQuest foi desenvolvido pelo PET-Informática. Qualquer dúvida, pode falar com a gente!</p>
									<ul class="contact">
										<li class="fa-envelope-o">pet-informatica@cin.ufpe.br</li>
										<li class="fa-home"><a href="https://pet-informatica.github.io">Website</a></li>
										<li class="fa-facebook"><a href="https://www.facebook.com/petinformatica/">Facebook</a></li>
									</ul>
								</section>
						</div>
					</div>
			</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/skel.min.js"></script>
			<script src="assets/js/util.js"></script>
			<!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
			<script src="assets/js/main.js"></script>

	</body>
</html>
